<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ´»å‹•å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ </title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.20.0/sdk.js"></script>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }
    #formError {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<form id="reportForm">
  <h1 id="formTitle"></h1>

  <label for="eventDate">é–‹å‚¬æ—¥:</label>
  <input type="date" id="eventDate" required />

  <label for="eventType">é–‹å‚¬ã‚¿ã‚¤ãƒ—:</label>
  <select id="eventType" required>
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    <option value="å­ã©ã‚‚é£Ÿå ‚ï¼ˆä¼šé£Ÿï¼‰">å­ã©ã‚‚é£Ÿå ‚ï¼ˆä¼šé£Ÿï¼‰</option>
    <option value="å­ã©ã‚‚é£Ÿå ‚ï¼ˆãŠå¼å½“é…å¸ƒï¼‰">å­ã©ã‚‚é£Ÿå ‚ï¼ˆãŠå¼å½“é…å¸ƒï¼‰</option>
    <option value="ãƒ•ãƒ¼ãƒ‰ãƒ‘ãƒ³ãƒˆãƒªãƒ¼">ãƒ•ãƒ¼ãƒ‰ãƒ‘ãƒ³ãƒˆãƒªãƒ¼</option>
    <option value="å­ã©ã‚‚é£Ÿå ‚ï¼†ãƒ•ãƒ¼ãƒ‰ãƒ‘ãƒ³ãƒˆãƒªãƒ¼">å­ã©ã‚‚é£Ÿå ‚ï¼†ãƒ•ãƒ¼ãƒ‰ãƒ‘ãƒ³ãƒˆãƒªãƒ¼</option>
  </select>

  <label for="adults">å‚åŠ äººæ•°ï¼ˆå¤§äººï¼‰:</label>
  <input type="number" id="adults" min="0" required />

  <label for="children">å‚åŠ äººæ•°ï¼ˆå­ã©ã‚‚ï¼‰:</label>
  <input type="number" id="children" min="0" required />

  <label for="staff">å‚åŠ äººæ•°ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ï¼‰:</label>
  <input type="number" id="staff" min="0" required />

  <label for="internalComments">ã‚³ãƒ¡ãƒ³ãƒˆ:</label>
  <textarea id="internalComments" placeholder="NWå†…éƒ¨ã«å…±æœ‰ã—ãŸã„æ°—ã¥ããªã©ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜å…¥" required></textarea>

  <div>
    <input type="file" id="imageUpload" hidden />
    <label for="imageUpload" class="custom-file-label">ç”»åƒã‚’é¸æŠ</label>
    <span class="file-name">æœªé¸æŠ</span>
  </div>

  <div id="photoPreview"></div>

  <button type="button" id="submitReport">é€ä¿¡</button>
  <div id="formError"></div>
</form>

<div id="confirmationModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>æ´»å‹•å ±å‘Šã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div class="preview-item"><b>é–‹å‚¬æ—¥:</b> <span id="confirmEventDate"></span></div>
    <div class="preview-item"><b>é–‹å‚¬ã‚¿ã‚¤ãƒ—:</b> <span id="confirmEventType"></span></div>
    <div class="preview-item"><b>å¤§äºº:</b> <span id="confirmAdults"></span></div>
    <div class="preview-item"><b>å­ã©ã‚‚:</b> <span id="confirmChildren"></span></div>
    <div class="preview-item"><b>ã‚¹ã‚¿ãƒƒãƒ•:</b> <span id="confirmStaff"></span></div>
    <div class="preview-item"><b>ã‚³ãƒ¡ãƒ³ãƒˆ:</b> <span id="confirmInternalComments"></span></div>
    <div id="confirmImagePreview"></div>
    <button id="confirmSubmit">ç¢ºå®š</button>
    <div class="loading-msg" id="loadingMsg">ãŠå¾…ã¡ãã ã•ã„ãƒ»ãƒ»ãƒ»</div>
  </div>
</div>

<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwyDc0GFNBChfjsbiAP9HLmWTWELhUPUOcsbV1iQZagEbUf-wHm1dLYJdx2XTkWLT8E8Q/exec";

const params = new URLSearchParams(window.location.search);
const userId = params.get("userId");
const siteName = params.get("siteName");
const nickname = params.get("nickname");

// ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
window.onload = function () {
  const titleElement = document.getElementById("formTitle");
  titleElement.innerHTML = `${siteName}<br>${nickname}ã•ã‚“ æ´»å‹•å ±å‘Šã‚’ã—ã¦ãã ã•ã„`;
};

// ç”»åƒåœ§ç¸®
async function compressImage(base64Data) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const maxWidth = 800;
      const maxHeight = 600;
      let width = img.width;
      let height = img.height;

      if (width > maxWidth) {
        height = Math.round((height * maxWidth) / width);
        width = maxWidth;
      }
      if (height > maxHeight) {
        width = Math.round((width * maxHeight) / height);
        height = maxHeight;
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);
      const compressed = canvas.toDataURL("image/jpeg", 0.7);
      resolve(compressed.split(",")[1]);
    };
    img.src = base64Data;
  });
}

// ç”»åƒé¸æŠ
let imageBase64 = "";
document.getElementById("imageUpload").addEventListener("change", (e) => {
  const file = e.target.files[0];
  document.querySelector(".file-name").textContent = file ? file.name : "æœªé¸æŠ";

  if (file) {
    const reader = new FileReader();
    reader.onload = async (event) => {
      imageBase64 = await compressImage(event.target.result);
      document.getElementById("confirmImagePreview").innerHTML = `<img src="${event.target.result}" width="150">`;
    };
    reader.readAsDataURL(file);
  }
});

// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãé€ä¿¡å‡¦ç†
document.getElementById("submitReport").addEventListener("click", () => {
  const eventDate = document.getElementById("eventDate").value;
  const eventType = document.getElementById("eventType").value;
  const adults = document.getElementById("adults").value;
  const children = document.getElementById("children").value;
  const staff = document.getElementById("staff").value;
  const internalComments = document.getElementById("internalComments").value;

  const errorEl = document.getElementById("formError");
  errorEl.textContent = "";

  const missingFields = [];
  if (!eventDate) missingFields.push("é–‹å‚¬æ—¥");
  if (!eventType) missingFields.push("é–‹å‚¬ã‚¿ã‚¤ãƒ—");
  if (!adults) missingFields.push("å‚åŠ äººæ•°ï¼ˆå¤§äººï¼‰");
  if (!children) missingFields.push("å‚åŠ äººæ•°ï¼ˆå­ã©ã‚‚ï¼‰");
  if (!staff) missingFields.push("å‚åŠ äººæ•°ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ï¼‰");
  if (!internalComments) missingFields.push("ã‚³ãƒ¡ãƒ³ãƒˆ");

  if (missingFields.length > 0) {
    errorEl.textContent = `${missingFields.join("ã€")}ãŒæœªå…¥åŠ›ã§ã™ã€‚`;
    return;
  }

  if (internalComments.length < 10) {
    errorEl.textContent = "ã‚³ãƒ¡ãƒ³ãƒˆã¯10æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«åæ˜ 
  document.getElementById("confirmEventDate").textContent = eventDate;
  document.getElementById("confirmEventType").textContent = eventType;
  document.getElementById("confirmAdults").textContent = adults;
  document.getElementById("confirmChildren").textContent = children;
  document.getElementById("confirmStaff").textContent = staff;
  document.getElementById("confirmInternalComments").textContent = internalComments;

  document.getElementById("confirmationModal").style.display = "flex";
});

// ç¢ºå®šâ†’é€ä¿¡å‡¦ç†
document.getElementById("confirmSubmit").addEventListener("click", async () => {
  document.getElementById("confirmSubmit").disabled = true;
  document.getElementById("loadingMsg").style.display = "block";

  const formData = new URLSearchParams({
    action: "report_submit",
    userId: userId,
    siteName: siteName,
    nickname: nickname,
    eventDate: document.getElementById("eventDate").value,
    eventType: document.getElementById("eventType").value,
    adults: document.getElementById("adults").value,
    children: document.getElementById("children").value,
    staff: document.getElementById("staff").value,
    internalComments: document.getElementById("internalComments").value,
    imageBase64: imageBase64
  });

  // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
  console.log("ğŸ”¥ Sending report with staff:", document.getElementById("staff").value);
  console.log("ğŸ”¥ Full formData:", Object.fromEntries(formData.entries()));

  try {
    const response = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: formData
    });

    const resultText = await response.text();
    let result;
    try {
      result = JSON.parse(resultText);
  } catch (e) {
    alert("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸æ­£ã§ã™: " + resultText);
    document.getElementById("loadingMsg").style.display = "none";
    document.getElementById("confirmSubmit").disabled = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†æœ‰åŠ¹åŒ–
    return;
  }

  if (result.status === "success") {
    document.getElementById("loadingMsg").style.display = "none";
    document.getElementById("confirmSubmit").disabled = false; // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
    showSuccessPopup("æ´»å‹•å ±å‘ŠãŒå®Œäº†ã—ã¾ã—ãŸã€‚æŠ•ç¨¿ã•ã‚ŒãŸã‚‰LINEã§é€šçŸ¥ã—ã¾ã™ã€‚");
    closeModal();
    document.getElementById("reportForm").reset();
    document.querySelector(".file-name").textContent = "æœªé¸æŠ"; // ãƒ•ã‚¡ã‚¤ãƒ«åã‚‚ãƒªã‚»ãƒƒãƒˆ
    document.getElementById("confirmImagePreview").innerHTML = ""; // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚ã‚¯ãƒªã‚¢
    imageBase64 = ""; // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚‚ãƒªã‚»ãƒƒãƒˆ
  } else {
    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + result.message);
    document.getElementById("loadingMsg").style.display = "none";
    document.getElementById("confirmSubmit").disabled = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†æœ‰åŠ¹åŒ–
  }
  } catch (err) {
    alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
    document.getElementById("loadingMsg").style.display = "none";
    document.getElementById("confirmSubmit").disabled = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†æœ‰åŠ¹åŒ–
  }
});

// æˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showSuccessPopup(message) {
  const successModal = document.createElement("div");
  successModal.classList.add("modal", "show");
  successModal.innerHTML = `
    <div class="modal-content">
      <h3>âœ… ${message}</h3>
      <button onclick="closeSuccessPopup()">OK</button>
    </div>`;
  document.body.appendChild(successModal);
}

function closeSuccessPopup() {
  const successModal = document.querySelector(".modal.show");
  if (successModal) successModal.remove();
}

  function closeModal() {
    document.getElementById("confirmationModal").style.display = "none";
    document.getElementById("confirmSubmit").disabled = false; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãŸæ™‚ã‚‚å†æœ‰åŠ¹åŒ–
  }
</script>

</body>
</html>
